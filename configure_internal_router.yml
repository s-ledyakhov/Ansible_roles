---
- hosts: all
  become: true

  tasks:
    - wait_for_connection:
        timeout: 300

    - name: Long form task does not
      ansible.builtin.replace:
        path: /etc/hosts
        before: "# The following lines are desirable for IPv6 capable hosts"
        regexp: '^127.0.0.1\tlocalhost$'
        replace: '127.0.0.1\t{{prefix}}-{{devname}}\tlocalhost'

    - name: Rename interface if they similar like "enp3s0" or "enp0s3"
      script: templates/introuter/ch_int_name.sh
      when: '"enp3s0" in ansible_default_ipv4.interface or "enp0s3" in ansible_default_ipv4.interface'

    - name: Update resolv.conf
      ansible.builtin.shell: sudo sed -i "s/nameserver 10.{{ s_oct }}.3.10/nameserver 172.18.4.210/g" /etc/resolv.conf

    - name: Update repositories cache and install "iptables" package
      ansible.builtin.apt:
        name: iptables
        update_cache: yes

    - name: Upgrade all packages on servers
      apt: upgrade=dist force_apt_get=yes

    - name: Check if a reboot is needed on all servers
      register: reboot_required_file
      stat: path=/var/run/reboot-required get_md5=no

    - name: Reboot the box if kernel updated
      reboot:
        msg: "Reboot initiated by Ansible for kernel updates"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      when: reboot_required_file.stat.exists

    - name: enable forwarding
      shell: "sysctl -w net.ipv4.ip_forward=1 >> /etc/sysctl.conf"
    - name: remove routes file
      file:
        path: /etc/network/if-up.d/routes
        state: absent
    - name: static interfaces
      template:
        src: templates/introuter/interfaces.j2
        dest: /etc/network/interfaces
        owner: root
        group: root
        mode: "0644"
    - name: disable cloudinit network config
      template:
        src: templates/introuter/95-debian-network-config.j2
        dest: /etc/cloud/cloud.cfg.d/95-debian-network-config.cfg
        owner: root
        group: root
        mode: "0644"
    - name: Clear cloudinit net state
      shell: "cp /dev/null /etc/network/interfaces.d/50-cloud-init.cfg"
    - name: iptables rules copy
      template:
        src: templates/introuter/iptables.up.j2
        dest: /etc/iptables.up.rules
        owner: root
        group: root
        mode: "0644"
    - name: make iptables pesistent
      template:
        src: templates/introuter/iptables.j2
        dest: /etc/network/if-pre-up.d/iptables
        owner: root
        group: root
        mode: "0744"
    - name: Rebooting the router
      reboot:
